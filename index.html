<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Mitchell Photos</title>

  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mitchell Photos">

  <style>
    :root{
      --bg:#0b1020;
      --card:#121c37;
      --border:#26355f;
      --text:#eef2ff;
      --muted:#a7b1d8;
      --primary:#3b82f6;
      --danger:#ef4444;
      --radius:14px;
      --shadow: 0 10px 26px rgba(0,0,0,.35);
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, #1a2a66 0%, rgba(26,42,102,0) 55%),
                  radial-gradient(900px 700px at 80% 0%, #173a7a 0%, rgba(23,58,122,0) 60%),
                  var(--bg);
      overflow:hidden;
      padding-top: var(--safe-t);
    }

    header{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    h1{ margin:0; font-size:16px; font-weight:800; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:12px; }

    main{
      height: calc(100% - 58px);
      overflow:auto;
      padding: 0 14px calc(18px + var(--safe-b)) 14px;
      -webkit-overflow-scrolling: touch;
    }

    .card{
      background: rgba(18,28,55,.78);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .grow{ flex: 1 1 220px; min-width:200px; }

    select, textarea, button{
      font: inherit;
    }

    select, textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,16,34,.55);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 86px; resize: vertical; }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      background: rgba(59,130,246,.20);
      border-color: rgba(59,130,246,.35);
    }
    .btn.danger{
      background: rgba(239,68,68,.20);
      border-color: rgba(239,68,68,.35);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .btn.sm{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 900;
    }

    .drop{
      border:2px dashed rgba(255,255,255,.16);
      border-radius: var(--radius);
      padding: 12px;
      text-align:center;
      background: rgba(0,0,0,.10);
    }
    .drop.drag{
      border-color: rgba(59,130,246,.85);
      background: rgba(59,130,246,.10);
    }

    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 820px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 520px){ .grid{ grid-template-columns: repeat(2, 1fr); } }

    .thumb{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      aspect-ratio: 1 / 1;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .thumb img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transform-origin: center center;
    }

    .tagbar{
      position:absolute;
      left:8px; right:8px; bottom:8px;
      display:flex; flex-wrap:wrap; gap:6px;
      pointer-events:none;
    }
    .chip{
      font-size:11px;
      padding: 5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(12,18,38,.65);
      backdrop-filter: blur(10px);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Reorder controls (only in Custom sort) */
    .reorderBar{
      position:absolute;
      top:8px; right:8px;
      display:flex; gap:6px;
      pointer-events:auto;
    }

    /* Viewer */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
      z-index: 50;
      display:none;
    }
    .overlay.show{ display:block; }

    .viewer{
      position:absolute;
      inset: 10px 10px 10px 10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(12,18,38,.90);
      box-shadow: var(--shadow);
      display:flex;
      overflow:hidden;
    }
    .vLeft{
      flex: 1.35;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.18);
      min-width:0;
      touch-action: pan-y;
    }
    .vLeft img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      transform-origin:center center;
    }
    .vRight{
      flex: 0.85;
      border-left:1px solid rgba(255,255,255,.10);
      padding:12px;
      overflow:auto;
      min-width: 280px;
    }
    @media (max-width: 900px){
      .viewer{ flex-direction:column; }
      .vRight{ border-left:none; border-top:1px solid rgba(255,255,255,.10); min-width:0; }
    }

    .topbar{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .topbar .group{ display:flex; gap:10px; pointer-events:auto; }

    .iconBtn{
      width:44px; height:44px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }

    /* Big side arrows */
    .arrow{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width:54px; height:54px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 24px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      pointer-events:auto;
    }
    .arrow.left{ left:10px; }
    .arrow.right{ right:10px; }
    .arrow[aria-disabled="true"]{ opacity:.4; cursor:not-allowed; }

    .small{ font-size:12px; color: var(--muted); }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight: 800;
      font-size:12px;
      color: var(--muted);
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(16px + var(--safe-b));
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:800;
      font-size:12px;
      z-index: 60;
      display:none;
      max-width: 92vw;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>Mitchell Photos</h1>
      <div class="muted">Add ‚Ä¢ Tag ‚Ä¢ Review ‚Ä¢ Rotate ‚Ä¢ Reorder</div>
    </div>
    <div class="pill"><span id="count">0</span> photos</div>
  </header>

  <main>
    <div class="card" style="margin-bottom:12px;">
      <div class="row" style="margin-bottom:10px;">
        <label class="btn primary" style="display:inline-flex; align-items:center; gap:8px;">
          üì∑ Add Photos
          <input id="fileInput" type="file" accept="image/*" multiple hidden>
        </label>

        <label class="btn" style="display:inline-flex; align-items:center; gap:8px;">
          üì∏ Camera
          <input id="camInput" type="file" accept="image/*" capture="environment" hidden>
        </label>

        <button class="btn" id="exportCsv">Export CSV</button>
        <button class="btn danger" id="wipeAll" title="Clears this device only">Wipe</button>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <div class="grow">
          <div class="small">Default Folder (new photos)</div>
          <select id="folderSel"></select>
        </div>
        <div class="grow">
          <div class="small">Default Category (new photos)</div>
          <select id="catSel"></select>
        </div>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <div class="grow">
          <div class="small">Sort</div>
          <select id="sortSel">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="name">Name</option>
            <option value="custom">Custom (use ‚Üë ‚Üì)</option>
          </select>
        </div>
        <div class="grow">
          <div class="small">Tip</div>
          <div class="small">Choose <b>Custom</b> to show reorder buttons on each thumbnail.</div>
        </div>
      </div>

      <div class="drop" id="dropZone">
        <b>Drag & drop photos here</b>
        <div class="small">Saved offline on this device. Tap to view. Swipe for next/prev.</div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="muted" style="text-align:center; padding: 22px 0; display:none;">
      No photos yet. Add some above.
    </div>
  </main>

  <!-- Viewer -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="viewer">
      <div class="vLeft" id="vLeft">
        <div class="topbar">
          <div class="group">
            <button class="iconBtn" id="closeBtn" title="Close">‚úï</button>
            <div class="pill" id="posPill">0 / 0</div>
          </div>
          <div class="group">
            <button class="iconBtn" id="prevBtn" title="Prev">‚Üê</button>
            <button class="iconBtn" id="nextBtn" title="Next">‚Üí</button>
          </div>
        </div>

        <div class="arrow left" id="bigPrev" aria-disabled="false">‚Äπ</div>
        <div class="arrow right" id="bigNext" aria-disabled="false">‚Ä∫</div>

        <img id="bigImg" alt="Photo" />
      </div>

      <div class="vRight">
        <div style="font-weight:900; margin-bottom:6px;">This photo</div>
        <div class="small" id="fileName">‚Äî</div>

        <div style="height:10px;"></div>

        <div class="small">Folder</div>
        <select id="vFolder"></select>

        <div style="height:10px;"></div>

        <div class="small">Category</div>
        <select id="vCat"></select>

        <div style="height:10px;"></div>

        <div class="small">Notes (optional)</div>
        <textarea id="vNotes" placeholder="Damage notes, parts notes, etc."></textarea>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn sm" id="rotL">‚ü≤ Rotate</button>
          <button class="btn sm" id="rotR">Rotate ‚ü≥</button>
          <button class="btn sm" id="flipH">‚áã Flip</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn primary" id="saveBtn">Save</button>
          <button class="btn danger" id="delBtn">Delete</button>
        </div>

        <div class="small" style="margin-top:10px;">
          Tips: Swipe left/right ‚Ä¢ Arrow keys ‚Üê/‚Üí ‚Ä¢ Esc closes
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // IndexedDB
  const DB_NAME = "mitchell_basic_photos_v2";
  const DB_VER = 1;
  const STORE_PHOTOS = "photos"; // {id, blob, type}
  const STORE_META   = "meta";   // {id, filename, created, folder, category, notes, rot, flip, order}

  // Simple defaults (edit these anytime)
  const FOLDERS = ["Unsorted","RO","Tear Down","Supplements","After Repair","Final"];
  const CATS    = ["Uncategorized","VIN","Odometer","Front","Rear","Left Side","Right Side","Damage","Repair Area","Parts"];

  let db;
  let meta = [];         // list of records
  let filtered = [];     // filtered list (same as meta for now)
  let viewerIndex = -1;

  // Defaults for new photos
  let defaultFolder = "Unsorted";
  let defaultCat = "Uncategorized";
  let sortMode = "newest";

  const $ = (s) => document.querySelector(s);

  // Toast
  const toastEl = $("#toast");
  let toastTimer = null;
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove("show"), 2000);
  }

  function uuid(){
    return crypto.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + Date.now());
  }
  function nowISO(){ return new Date().toISOString(); }

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onerror = () => reject(req.error);
      req.onupgradeneeded = () => {
        const d = req.result;
        if (!d.objectStoreNames.contains(STORE_PHOTOS)) d.createObjectStore(STORE_PHOTOS, {keyPath:"id"});
        if (!d.objectStoreNames.contains(STORE_META))   d.createObjectStore(STORE_META,   {keyPath:"id"});
      };
      req.onsuccess = () => resolve(req.result);
    });
  }
  function tx(stores, mode="readonly"){ return db.transaction(stores, mode); }
  function idbGet(store, key){
    return new Promise((resolve, reject) => {
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  function idbPut(store, val){
    return new Promise((resolve, reject) => {
      const req = store.put(val);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  function idbDel(store, key){
    return new Promise((resolve, reject) => {
      const req = store.delete(key);
      req.onsuccess = () => resolve(true);
      req.onerror = () => reject(req.error);
    });
  }
  function idbGetAll(store){
    return new Promise((resolve, reject) => {
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  }

  // CSV export
  function downloadText(filename, text, type="text/plain"){
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function csv(s){
    const t = (s ?? "").toString().replaceAll('"','""');
    return `"${t}"`;
  }
  function dateStamp(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}${m}${day}`;
  }

  // Build selects
  function buildSelects(){
    $("#folderSel").innerHTML = FOLDERS.map(f => `<option value="${esc(f)}">${esc(f)}</option>`).join("");
    $("#catSel").innerHTML = CATS.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join("");
    $("#vFolder").innerHTML = FOLDERS.map(f => `<option value="${esc(f)}">${esc(f)}</option>`).join("");
    $("#vCat").innerHTML = CATS.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join("");

    $("#folderSel").value = defaultFolder;
    $("#catSel").value = defaultCat;
    $("#sortSel").value = sortMode;
  }
  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // Sorting
  function getSorted(list){
    const arr = list.slice();
    if (sortMode === "newest") arr.sort((a,b) => (b.created||"").localeCompare(a.created||""));
    if (sortMode === "oldest") arr.sort((a,b) => (a.created||"").localeCompare(b.created||""));
    if (sortMode === "name")   arr.sort((a,b) => (a.filename||"").localeCompare(b.filename||"", undefined, {sensitivity:"base"}));
    if (sortMode === "custom") arr.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
    return arr;
  }

  async function init(){
    db = await openDB();
    const all = await idbGetAll(tx([STORE_META], "readonly").objectStore(STORE_META));
    // Migration-safe defaults
    meta = all.map(m => ({
      id: m.id,
      filename: m.filename || "photo.jpg",
      created: m.created || nowISO(),
      folder: m.folder || "Unsorted",
      category: m.category || "Uncategorized",
      notes: m.notes || "",
      rot: Number.isFinite(m.rot) ? m.rot : 0,       // 0,90,180,270
      flip: !!m.flip,                                 // horizontal flip
      order: Number.isFinite(m.order) ? m.order : 0   // custom ordering
    }));

    // If order is all zeros, initialize a stable custom order based on created time (oldest first)
    if (meta.length && meta.every(x => x.order === 0)){
      const byOldest = meta.slice().sort((a,b) => (a.created||"").localeCompare(b.created||""));
      byOldest.forEach((x, i) => x.order = i+1);
      await persistMany(byOldest.map(x => ({id:x.id, patch:{order:x.order}})));
      meta = byOldest; // keep
    }

    buildSelects();
    wireUI();
    render();
  }

  function wireUI(){
    // defaults
    $("#folderSel").addEventListener("change", (e) => defaultFolder = e.target.value);
    $("#catSel").addEventListener("change", (e) => defaultCat = e.target.value);

    // sort
    $("#sortSel").addEventListener("change", (e) => {
      sortMode = e.target.value;
      render();
    });

    // file add
    $("#fileInput").addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      e.target.value = "";
      if (files.length) await addFiles(files);
    });
    $("#camInput").addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      e.target.value = "";
      if (files.length) await addFiles(files);
    });

    // drop
    const dz = $("#dropZone");
    ["dragenter","dragover"].forEach(ev => dz.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      dz.classList.add("drag");
    }));
    ["dragleave","drop"].forEach(ev => dz.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      dz.classList.remove("drag");
    }));
    dz.addEventListener("drop", async (e) => {
      const files = Array.from(e.dataTransfer.files || []).filter(f => f.type.startsWith("image/"));
      if (!files.length) return toast("No image files detected.");
      await addFiles(files);
    });

    // export
    $("#exportCsv").addEventListener("click", exportCSV);

    // wipe device
    $("#wipeAll").addEventListener("click", async () => {
      if (!confirm("Wipe all photos on THIS device/browser?")) return;
      await wipeAll();
      toast("Wiped.");
      render();
    });

    // viewer controls
    $("#closeBtn").addEventListener("click", closeViewer);
    $("#overlay").addEventListener("click", (e) => { if (e.target.id === "overlay") closeViewer(); });

    const step = (dir) => {
      const next = viewerIndex + dir;
      if (next < 0 || next >= filtered.length) return;
      viewerIndex = next;
      renderViewer();
    };

    $("#prevBtn").addEventListener("click", () => step(-1));
    $("#nextBtn").addEventListener("click", () => step(+1));
    $("#bigPrev").addEventListener("click", () => step(-1));
    $("#bigNext").addEventListener("click", () => step(+1));

    // swipe
    let sx=0, sy=0, st=0;
    $("#vLeft").addEventListener("touchstart", (e) => {
      const t = e.touches?.[0]; if (!t) return;
      sx = t.clientX; sy = t.clientY; st = Date.now();
    }, {passive:true});
    $("#vLeft").addEventListener("touchend", (e) => {
      const t = e.changedTouches?.[0]; if (!t) return;
      const dx = t.clientX - sx;
      const dy = t.clientY - sy;
      const dt = Date.now() - st;
      if (Math.abs(dx) > 45 && Math.abs(dx) > Math.abs(dy) * 1.2 && dt < 650){
        if (dx < 0) step(+1); else step(-1);
      }
    }, {passive:true});

    // keyboard
    document.addEventListener("keydown", (e) => {
      if (!$("#overlay").classList.contains("show")) return;
      if (e.key === "Escape") closeViewer();
      if (e.key === "ArrowLeft") step(-1);
      if (e.key === "ArrowRight") step(+1);
    });

    // viewer tagging
    $("#saveBtn").addEventListener("click", async () => {
      const rec = filtered[viewerIndex];
      if (!rec) return;
      await updateMeta(rec.id, {
        folder: $("#vFolder").value,
        category: $("#vCat").value,
        notes: $("#vNotes").value || ""
      });
      toast("Saved.");
      render(false);
      renderViewer();
    });

    $("#delBtn").addEventListener("click", async () => {
      const rec = filtered[viewerIndex];
      if (!rec) return;
      if (!confirm("Delete this photo?")) return;
      await deleteOne(rec.id);
      toast("Deleted.");
      render(false);
      if (!filtered.length) closeViewer();
      else {
        viewerIndex = Math.min(viewerIndex, filtered.length - 1);
        renderViewer();
      }
    });

    // simple photo edit (visual + saved)
    $("#rotL").addEventListener("click", async () => rotate(-90));
    $("#rotR").addEventListener("click", async () => rotate(+90));
    $("#flipH").addEventListener("click", async () => flip());

    async function rotate(delta){
      const rec = filtered[viewerIndex];
      if (!rec) return;
      const cur = meta.find(x => x.id === rec.id);
      const nextRot = (((cur.rot || 0) + delta) % 360 + 360) % 360;
      await updateMeta(rec.id, {rot: nextRot});
      render(false);
      renderViewer();
    }
    async function flip(){
      const rec = filtered[viewerIndex];
      if (!rec) return;
      const cur = meta.find(x => x.id === rec.id);
      await updateMeta(rec.id, {flip: !cur.flip});
      render(false);
      renderViewer();
    }
  }

  async function persistMany(items){
    const t = tx([STORE_META], "readwrite");
    const sM = t.objectStore(STORE_META);
    for (const it of items){
      const cur = await idbGet(sM, it.id);
      if (!cur) continue;
      await idbPut(sM, {...cur, ...it.patch});
    }
  }

  async function addFiles(files){
    const t = tx([STORE_PHOTOS, STORE_META], "readwrite");
    const sP = t.objectStore(STORE_PHOTOS);
    const sM = t.objectStore(STORE_META);

    // for custom ordering: append to end
    const maxOrder = meta.reduce((m,x) => Math.max(m, x.order ?? 0), 0);

    let added = 0;
    for (const f of files){
      if (!f.type.startsWith("image/")) continue;
      const id = uuid();
      await idbPut(sP, {id, blob: f, type: f.type || "image/jpeg"});
      const m = {
        id,
        filename: f.name || `photo_${added+1}.jpg`,
        created: nowISO(),
        folder: defaultFolder,
        category: defaultCat,
        notes: "",
        rot: 0,
        flip: false,
        order: maxOrder + added + 1
      };
      await idbPut(sM, m);
      meta.push(m);
      added++;
    }
    toast(`Added ${added} photo(s).`);
    render();
  }

  async function updateMeta(id, patch){
    const t = tx([STORE_META], "readwrite");
    const sM = t.objectStore(STORE_META);
    const cur = await idbGet(sM, id);
    if (!cur) return;
    await idbPut(sM, {...cur, ...patch});

    const idx = meta.findIndex(x => x.id === id);
    if (idx >= 0) meta[idx] = {...meta[idx], ...patch};
  }

  async function deleteOne(id){
    const t = tx([STORE_PHOTOS, STORE_META], "readwrite");
    await idbDel(t.objectStore(STORE_PHOTOS), id).catch(()=>{});
    await idbDel(t.objectStore(STORE_META), id).catch(()=>{});
    meta = meta.filter(x => x.id !== id);
  }

  async function wipeAll(){
    await new Promise((resolve) => {
      const req = indexedDB.deleteDatabase(DB_NAME);
      req.onsuccess = resolve;
      req.onerror = resolve;
      req.onblocked = resolve;
    });
    db = await openDB();
    meta = [];
    filtered = [];
    viewerIndex = -1;
  }

  function applyTransform(el, rec){
    const r = rec.rot || 0;
    const flip = rec.flip ? -1 : 1;
    // rotate + optional horizontal flip
    el.style.transform = `rotate(${r}deg) scaleX(${flip})`;
  }

  function render(updateCount=true){
    if (updateCount) $("#count").textContent = String(meta.length);
    $("#empty").style.display = meta.length ? "none" : "";

    filtered = getSorted(meta);

    const grid = $("#grid");
    grid.innerHTML = "";

    const showReorder = (sortMode === "custom");

    filtered.forEach((m, index) => {
      const div = document.createElement("div");
      div.className = "thumb";
      div.dataset.id = m.id;

      const img = document.createElement("img");
      img.alt = m.filename || "photo";
      div.appendChild(img);

      const tags = document.createElement("div");
      tags.className = "tagbar";
      tags.innerHTML = `<span class="chip">${esc(m.folder)}</span><span class="chip">${esc(m.category)}</span>`;
      div.appendChild(tags);

      if (showReorder){
        const rb = document.createElement("div");
        rb.className = "reorderBar";

        const up = document.createElement("button");
        up.className = "btn sm";
        up.textContent = "‚Üë";
        up.title = "Move up";
        up.disabled = (index === 0);

        const down = document.createElement("button");
        down.className = "btn sm";
        down.textContent = "‚Üì";
        down.title = "Move down";
        down.disabled = (index === filtered.length - 1);

        up.addEventListener("click", async (e) => {
          e.stopPropagation();
          await move(index, index - 1);
        });
        down.addEventListener("click", async (e) => {
          e.stopPropagation();
          await move(index, index + 1);
        });

        rb.appendChild(up);
        rb.appendChild(down);
        div.appendChild(rb);
      }

      div.addEventListener("click", () => openViewerByIndex(index));

      grid.appendChild(div);
      loadThumb(m.id, img, m);
    });
  }

  async function move(fromIndex, toIndex){
    if (toIndex < 0 || toIndex >= filtered.length) return;
    // swap order values between the two records
    const a = filtered[fromIndex];
    const b = filtered[toIndex];
    const ao = a.order ?? 0;
    const bo = b.order ?? 0;

    await updateMeta(a.id, {order: bo});
    await updateMeta(b.id, {order: ao});

    toast("Moved.");
    render(false);
  }

  async function loadThumb(id, imgEl, rec){
    try{
      const t = tx([STORE_PHOTOS], "readonly");
      const r = await idbGet(t.objectStore(STORE_PHOTOS), id);
      if (!r?.blob) return;
      const url = URL.createObjectURL(r.blob);
      imgEl.src = url;
      imgEl.onload = () => URL.revokeObjectURL(url);
      applyTransform(imgEl, rec);
    } catch(e){
      console.error(e);
    }
  }

  function openViewerByIndex(i){
    viewerIndex = i;
    $("#overlay").classList.add("show");
    $("#overlay").setAttribute("aria-hidden", "false");
    renderViewer();
  }

  function closeViewer(){
    $("#overlay").classList.remove("show");
    $("#overlay").setAttribute("aria-hidden", "true");
    $("#bigImg").src = "";
    viewerIndex = -1;
  }

  function setArrowState(){
    const canPrev = viewerIndex > 0;
    const canNext = viewerIndex < filtered.length - 1;
    $("#prevBtn").disabled = !canPrev;
    $("#nextBtn").disabled = !canNext;
    $("#bigPrev").setAttribute("aria-disabled", canPrev ? "false" : "true");
    $("#bigNext").setAttribute("aria-disabled", canNext ? "false" : "true");
  }

  async function renderViewer(){
    const rec = filtered[viewerIndex];
    if (!rec) return;

    $("#posPill").textContent = `${viewerIndex+1} / ${filtered.length}`;
    $("#fileName").textContent = rec.filename || "‚Äî";
    $("#vFolder").value = rec.folder || "Unsorted";
    $("#vCat").value = rec.category || "Uncategorized";
    $("#vNotes").value = rec.notes || "";

    setArrowState();

    try{
      const t = tx([STORE_PHOTOS], "readonly");
      const r = await idbGet(t.objectStore(STORE_PHOTOS), rec.id);
      if (!r?.blob) { $("#bigImg").src = ""; return; }
      const url = URL.createObjectURL(r.blob);
      const img = $("#bigImg");
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);
      applyTransform(img, rec);
    } catch(e){
      console.error(e);
    }
  }

  function exportCSV(){
    const header = ["id","filename","created","folder","category","rot","flip","order","notes"].join(",");
    const lines = getSorted(meta).map(m => [
      m.id,
      csv(m.filename),
      m.created,
      csv(m.folder),
      csv(m.category),
      String(m.rot||0),
      m.flip ? "true" : "false",
      String(m.order ?? 0),
      csv(m.notes)
    ].join(","));
    downloadText(`mitchell_photos_${dateStamp()}.csv`, [header, ...lines].join("\n"), "text/csv");
    toast("CSV exported.");
  }

  // Boot
  init().catch(err => {
    console.error(err);
    toast("Failed to load.");
  });
})();
</script>
</body>
</html>
